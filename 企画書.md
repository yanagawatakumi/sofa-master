# ソファマスター 仕様書 & タスク一覧

## 1. アプリ全体像

### コンセプト
ユーザーの好み・予算・ライフスタイルをヒアリングし、最適なソファを提案。さらにユーザーの部屋写真にソファを合成して「実際に置いた時のイメージ」を提供するWebアプリ。

### 2ステップフロー
```
[Step 1: ヒアリング + 部屋画像選択] → [Step 2: おすすめ提案 + 合成]
```

### 現状の実装状況
- **実装済み**: Step 1（ヒアリングUI + API連携）
- **実装済み**: Step 2（提案UIのカード一覧・詳細モーダル・カラー切替の基礎）
- **未対応**: Step1で部屋画像選択、Step2モーダル内で合成フロー

---

## 2. Step 1: ヒアリング + 部屋画像選択

### UI形式
チャット風UI（LINE風の吹き出し形式）で、定型質問を1つずつ表示。

### 質問一覧（全7問）

| # | 質問ID | 質問文 | 選択形式 | 選択肢 |
|---|--------|--------|----------|--------|
| 1 | `budget` | ソファのご予算はどのくらいですか？ | 単一選択 | ~5万円 / 5~10万円 / 10~20万円 / 20~30万円 / 30万円以上 |
| 2 | `capacity` | 何人でお使いになりますか？ | 単一選択 | 1人 / 2人 / 3人以上 / 来客時にも使いたい |
| 3 | `space` | ソファを置くスペースの幅はどのくらいですか？ | 単一選択 | ~150cm / 150~200cm / 200~250cm / 250cm以上 / わからない |
| 4 | `style` | お好みのインテリアスタイルは？（2つまで） | 複数選択(max2) | モダン / 北欧 / ナチュラル / クラシック / インダストリアル / 和モダン / こだわりなし |
| 5 | `material` | お好みの素材は？ | 単一選択 | 本革 / 合皮 / ファブリック / こだわりなし |
| 6 | `color` | お好みのカラー系統は？（2つまで） | 複数選択(max2) | ベージュ系 / グレー系 / ブラウン系 / ブラック系 / ネイビー系 / グリーン系 / こだわりなし |
| 7 | `lifestyle` | 当てはまるものを全て選んでください | 複数選択 | 小さなお子様がいる / ペットを飼っている / ソファで寝ることがある / 収納付きが良い / リクライニングが欲しい / 特になし |

### 質問設計の意図
- Q1~Q3: **ハードフィルタ**（予算・人数・スペースで物理的に合わない商品を除外）
- Q4~Q6: **ソフトスコアリング**（好みに応じてマッチ度を算出）
- Q7: **ボーナススコア**（ライフスタイルに合う機能を持つ商品を加点）

### UI動作
1. ボット吹き出しがタイピングアニメーション付きで表示
2. 選択肢がボタンとして表示される
3. ユーザーがタップすると、右側に回答吹き出しが表示
4. 次の質問が表示される（複数選択の場合は「次へ」ボタンで進む）
5. 全問回答後、回答サマリーカードを表示
6. 部屋画像のアップロード or テンプレ選択を行う
7. 「おすすめを見る」ボタンでStep 2へ遷移
7. 過去の回答吹き出しをタップすると、その質問からやり直し可能

---

## 3. Step 2: おすすめ提案 + 合成

### 提案ロジック（2段階）

**Phase 1 - ハードフィルタ（除外）**
- 予算上限を超える商品を除外
- 必要な座席数に満たない商品を除外
- 設置幅を超える商品を除外（+10cm許容）
- 素材が合わない商品を除外（「こだわりなし」ならスキップ）

**Phase 2 - スコアリング（0~100点）**

| 項目 | 配点 | 基準 |
|------|------|------|
| スタイル一致 | 30点 | スタイルタグが一致するか |
| カラー一致 | 20点 | 選択カラーグループに該当色があるか |
| 予算フィット | 20点 | 予算の60~90%が最高スコア |
| ライフスタイル | 20点 | 選択したライフスタイル項目に対応する機能/タグの一致率 |
| 人数フィット | 10点 | ぴったり > 1サイズ大 > 2サイズ大 |

**結果が3件未満の場合**: スペース制約 → 素材制約 の順に緩和し、「近い条件の商品も表示しています」と表示。

### 提案UI
- 上位5件をカード形式で表示
- 各カードに: 商品画像 / 商品名 / 価格 / マッチ度(%) / 主要スペック / カラーバリエーション（スウォッチ切り替え）
- 「詳細を見る」→ モーダルで全情報表示（サイズ詳細、説明文、メーカー名、購入リンク）
- モーダル内で「部屋画像 + ソファ」を合成し結果を表示
- 「ヒアリングをやり直す」→ Step 1に戻る

### 複数角度画像の活用
- カード上では**メイン画像（正面）**を表示
- 詳細展開時に**複数角度の画像をスライドショー/サムネイル切り替え**で閲覧可能
- 合成にはAI合成に最も適した角度の画像を `composition_image` として指定

---

## 4. 部屋画像選択（Step1に統合）

### 方針
- Step1の最後で部屋画像をアップロード or テンプレ選択
- Step2の合成はStep1で選んだ部屋画像を共通利用

---

## 5. ソファデータベース設計

### 形式: JSONファイル
既存のスプレッドシートデータをJSON形式に変換して使用。商品数が数百件以下であれば十分なパフォーマンス。

### スキーマ: `data/sofas.json`

```json
{
  "sofas": [
    {
      "id": "sofa-001",
      "name": "商品名",
      "maker": "メーカー名",
      "price": 89800,
      "size": {
        "width": 195,
        "depth": 85,
        "height": 80,
        "seat_height": 42
      },
      "capacity": 3,
      "styles": ["nordic", "natural"],
      "material": "fabric",
      "colors": [
        {
          "name": "ライトグレー",
          "color_group": "gray",
          "image_path": "/images/sofas/catalog/sofa-001/main-gray.png",
          "hex": "#B0B0B0"
        }
      ],
      "default_color_index": 0,
      "images": {
        "angles": [
          "/images/sofas/catalog/sofa-001/front.png",
          "/images/sofas/catalog/sofa-001/side.png",
          "/images/sofas/catalog/sofa-001/detail.png"
        ]
      },
      "features": ["washable_cover"],
      "tags": ["kids_friendly"],
      "description": "商品説明テキスト",
      "product_url": "https://example.com/sofa-001",
      "composition_image": "/images/sofas/catalog/sofa-001/main-gray.png"
    }
  ]
}
```

### enum定義
- **styles**: `modern` | `nordic` | `natural` | `classic` | `industrial` | `japanese_modern`
- **material**: `leather` | `synthetic_leather` | `fabric`
- **color_group**: `beige` | `gray` | `brown` | `black` | `navy` | `green` | `other`
- **features**: `reclining` | `storage` | `sofa_bed` | `washable_cover` | `ottoman_set`
- **tags**: `compact` | `kids_friendly` | `pet_friendly` | `stain_resistant` | `lightweight`

### スプレッドシートからの移行
- スプレッドシートの列をJSONフィールドにマッピングする変換スクリプトを作成
- または手動で初回分を作成し、以降はJSONを直接編集

### 画像フォルダ構造
```
images/sofas/catalog/
├── sofa-001/
│   ├── main-gray.png      ← メイン画像（合成にも使用）
│   ├── main-beige.png     ← カラバリ
│   ├── front.png          ← 正面アングル
│   ├── side.png           ← 側面アングル
│   └── detail.png         ← ディテール
├── sofa-002/
│   └── ...
```

---

## 6. APIエンドポイント設計

### 新規エンドポイント

| メソッド | パス | 説明 |
|----------|------|------|
| `GET` | `/api/hearing/questions` | ヒアリング質問定義を返す |
| `POST` | `/api/recommend` | 回答を受け取り、おすすめソファを返す |
| `GET` | `/api/sofas` | 全ソファ一覧（スキップ時用） |
| `GET` | `/api/sofas/:id` | ソファ詳細取得 |

### 既存エンドポイント（変更なし）

| メソッド | パス | 説明 |
|----------|------|------|
| `POST` | `/api/compose` | 画像合成（Gemini AI） |
| `POST` | `/api/upload-room` | 部屋画像アップロード |
| `GET` | `/api/uploaded-rooms` | アップロード済み部屋画像一覧 |

---

## 7. ファイル構成（変更後）

```
CC0203/
├── data/
│   ├── sofas.json              ← NEW: ソファDB
│   └── questions.json          ← NEW: ヒアリング質問定義
├── images/
│   ├── rooms/                  （変更なし）
│   └── sofas/
│       ├── (既存3枚)           （維持）
│       └── catalog/            ← NEW: カタログ画像
│           ├── sofa-001/
│           └── ...
├── src/
│   ├── index.html              ← MODIFY: 3ステップUI追加
│   ├── css/
│   │   └── style.css           ← MODIFY: チャットUI・カードUI追加
│   └── js/
│       ├── app.js              ← MODIFY: 2ステップ管理に改修
│       ├── hearing.js          ← MODIFY: 部屋画像選択を追加
│       └── recommend.js        ← MODIFY: モーダル内で合成
├── server/
│   ├── server.js               ← MODIFY: 新APIエンドポイント追加
│   ├── recommend.js            ← NEW: 提案アルゴリズム
│   └── ...
└── scripts/
    └── convert-spreadsheet.js  ← NEW: スプシ→JSON変換（任意）
```

---

## 7.1 実装分割（スニペット単位の粒度）

並行開発を前提に、**責務単位で分割**する。1スニペットは「1機能の入力→表示 or 1ロジック」を最小単位とする。

### フロントエンド（JS）

- `src/js/app.js`
  - 2ステップ遷移管理
  - 共通状態（selectedRoom / hearingAnswers）

- `src/js/hearing.js`
  - `initHearing()`：初期化・質問取得
  - `renderBotMessage()`：ボット吹き出し描画
  - `renderChoices()`：選択肢ボタン描画
  - `handleAnswer()`：回答登録
  - `renderSummary()`：回答サマリー表示
  - `renderRoomSelection()`：部屋画像の選択/アップロード

- `src/js/recommend.js`
  - `fetchRecommend()`：推薦API呼び出し
  - `renderRecommendList()`：カード一覧描画
  - `renderSofaCard()`：1カード描画
  - `bindColorSwatches()`：カラー切替
  - `openDetailModal()`：詳細表示 + モーダル内合成

### フロントエンド（CSS）

- `src/css/style.css` を大区分で分割記述（1ブロック = 1コンポーネント）
  - `/* Progress */`
  - `/* Hearing Chat */`
  - `/* Recommend Cards */`
  - `/* Detail Modal */`
  - `/* Compose */`

### バックエンド

- `server/server.js`
  - データ読込（sofas/questions）
  - ルーティング定義のみ

- `server/recommend.js`
  - `hardFilter()`：除外条件
  - `scoreSofa()`：スコア算出
  - `recommend()`：上位抽出/緩和

### データ

- `data/questions.json` を1問1オブジェクト（UI表示と一致）
- `data/sofas.json` は1商品1オブジェクト（composition_image を必須）

---

## 8. タスク一覧

### フェーズA: データ基盤

| # | タスク | 対象ファイル | 依存 |
|---|--------|-------------|------|
| A1 | ソファDBスキーマ定義 + サンプルデータ作成 | `data/sofas.json` | なし |
| A2 | ヒアリング質問データ作成 | `data/questions.json` | なし |
| A3 | スプレッドシートからのデータ移行方法検討 | `scripts/convert-spreadsheet.js` | A1 |
| A4 | ソファカタログ画像の整理・配置 | `images/sofas/catalog/` | A1 |

### フェーズB: バックエンドAPI

| # | タスク | 対象ファイル | 依存 |
|---|--------|-------------|------|
| B1 | サーバー起動時にソファDB・質問データを読み込み | `server/server.js` | A1, A2 |
| B2 | `GET /api/hearing/questions` 実装 | `server/server.js` | B1 |
| B3 | 提案アルゴリズム実装（フィルタ+スコアリング） | `server/recommend.js` | A1 |
| B4 | `POST /api/recommend` 実装 | `server/server.js` | B1, B3 |
| B5 | `GET /api/sofas`, `GET /api/sofas/:id` 実装 | `server/server.js` | B1 |

### フェーズC: フロントエンド - 基盤 & ヒアリング

| # | タスク | 対象ファイル | 依存 |
|---|--------|-------------|------|
| C1 | HTML構造を3ステップ構成に改修 + プログレスバー追加 | `src/index.html` | なし |
| C2 | チャットUI・提案カード・プログレスバーのCSS追加 | `src/css/style.css` | C1 |
| C3 | app.jsをステップベースのナビゲーションに改修 | `src/js/app.js` | C1 |
| C4 | ヒアリングチャットUI実装 | `src/js/hearing.js` | B2, C1, C2 |

### フェーズD: フロントエンド - 提案 & 合成連携

| # | タスク | 対象ファイル | 依存 |
|---|--------|-------------|------|
| D1 | おすすめ提案画面の実装（カード表示・カラー切替・詳細モーダル） | `src/js/recommend.js` | B4, C2, C3 |
| D2 | 提案→合成の連携（選択ソファの受け渡し・Step 3改修） | `src/js/app.js` | D1 |
| D3 | 複数角度画像の表示（詳細モーダル内スライドショー） | `src/js/recommend.js` | D1 |

### フェーズE: 統合 & 仕上げ

| # | タスク | 対象ファイル | 依存 |
|---|--------|-------------|------|
| E1 | 「スキップして全ソファを見る」フロー実装 | `src/js/recommend.js` | D1, B5 |
| E2 | エラーハンドリング（API失敗・結果0件等） | 各ファイル | C4, D1 |
| E3 | レスポンシブ対応の確認・調整 | `src/css/style.css` | C2, D1 |
| E4 | 全体通しテスト | - | 全タスク |

### 推奨実装順序
```
A1 + A2 + C1（並行）
  ↓
A3 + A4 + C2（並行）
  ↓
B1 → B2 + B3（並行）→ B4 + B5
  ↓
C3 → C4
  ↓
D1 → D2 + D3
  ↓
E1 → E2 → E3 → E4
```

---

## 9. 技術方針まとめ

| 項目 | 方針 |
|------|------|
| フレームワーク | Vanilla JS維持（React/Vue不使用） |
| DB | JSONファイル（商品数が数百件以下のため） |
| 質問データ | サーバーからAPI提供（フロント変更なしで質問更新可能） |
| 提案ロジック | サーバーサイド実行（データ非公開・ロジック集約） |
| 新規依存パッケージ | なし（既存スタックで全機能実現可能） |
| ステップ遷移 | CSS show/hideでSPA的に実現（ルーティングライブラリ不要） |
| 画像管理 | 商品IDごとのフォルダに複数角度画像を格納 |

---

## 10. 動作確認方法

1. `cd server && node server.js` でサーバー起動
2. `http://localhost:3000` にアクセス
3. Step 1: 7問の質問に回答
4. Step 2: おすすめソファが表示されること、マッチ度・詳細・カラー切替を確認
5. Step 3: ソファを選択→部屋画像を選択→合成→ダウンロードの全フローを確認
6. 「ヒアリングをやり直す」「別のソファを選ぶ」等の戻りフローを確認
7. モバイル表示の確認
